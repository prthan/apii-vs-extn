!function(window){"apii".split(".").reduce((a,e)=>a[e]=a[e]||{},window).Module=class{constructor(options){this.options=options,this.eventHandlers={}}init(){return new Promise(async(res,rej)=>{console.info("[APIi]","module initialized"),res()})}}}(window),function(window){"apii".split(".").reduce((a,e)=>a[e]=a[e]||{},window).Send=class{static exec(inspection){return new Promise(async($res,$rej)=>{let options={method:inspection.target.method};["GET","HEAD"].includes(options.method)||(options.body=inspection.request.content);let headers={};inspection.request.headers.forEach(item=>{item.header&&""!=item.header.trim()&&(headers[item.header]=item.value)}),options.headers=headers,options.credentials="include",options.mode="cors";let startTime=performance.now();fetch(inspection.target.endpoint,options).then(response=>{response.text().then(responseText=>{let headers=inspection.response.headers=[];headers.push();for(let item of response.headers.entries())headers.push({header:item[0],value:item[1]});inspection.response.headers=headers,inspection.response.status={code:response.status,text:response.statusText},inspection.response.content=responseText,inspection.response.time=performance.now()-startTime,inspection.response.time=Math.round(1e3*(performance.now()-startTime)+.5)/1e3,$res(inspection)})}).catch(ex=>{inspection.response.headers=[],inspections.response.status={code:-1,text:"error sending the request"},inspection.response.content=JSON.stringify(ex),inspection.response.time=Math.round(1e3*(performance.now()-startTime)+.5)/1e3,$res(inspection)})})}}}(window),function(window){class JSDom{constructor(data){this.doc=null,this.ns={},this.instructions=[],data&&this.parse(data)}parse(data){let jsdom=this,obj={},tagsPath=[],saxparser=sax.parser(!0,{xmlns:!0,trim:!0});saxparser.onerror=(e=>console.log(e)),saxparser.onopentag=(node=>{let tag={$ns:node.ns[node.prefix]};jsdom.setAttributes(tag,node.attributes);let tagName=`${node.local}`;if(obj[tagName]){let _tag=obj[tagName];_tag instanceof Array?_tag.push(tag):obj[tagName]=[_tag,tag]}else obj[tagName]=tag;tagsPath.push(obj),obj=tag,Object.keys(node.ns).filter(k=>""!=k).forEach(key=>jsdom.ns[key]=node.ns[key])}),saxparser.onclosetag=(()=>{obj=tagsPath.pop()}),saxparser.ontext=(text=>obj.$value=text),saxparser.oncdata=(text=>obj.$value=text),saxparser.onprocessinginstruction=(instruction=>{jsdom.instructions.push(instruction)}),saxparser.write(data).close(),jsdom.doc=obj}setAttributes(obj,attrs){Object.keys(attrs).forEach(key=>obj[`@${key}`]=attrs[key].value)}array(a){return null==a?[]:a instanceof Array?a:[a]}generate(indent){let dom=this,rootName=Object.keys(dom.doc)[0],nsmap=Object.keys(dom.ns).reduce((a,c)=>(a[dom.ns[c]]=c,a),{});return dom.instructions.reduce((a,c)=>a+=`<?${c.name} ${c.body}?>\n`,"")+dom.generateNode(dom.doc[rootName],rootName,indent,nsmap)}generateNode(o,name,indent,nsmap,level){let dom=this,nl="\n";indent||(indent=0,nl=""),level||(level=0);let spaces=`${dom.space(level*indent)}`,tags=[];return(o instanceof Array?o:[o]).forEach(node=>{let prefix="",ns="";nsmap&&nsmap[node.$ns]&&(prefix=nsmap[node.$ns]+":"),""==prefix&&node.$ns&&(ns=` xmlns="${node.$ns}"`);let nsvals="";if(0==level&&nsmap&&(nsvals=Object.keys(nsmap).reduce((a,c)=>a+=` xmlns:${nsmap[c]}="${c}"`,"")),node.$value||""==node.$value)tags.push(`${spaces}<${prefix}${name}${ns}${nsvals}${dom.attrs(node)}>${node.$value}</${prefix}${name}>`);else{let openTag=`${spaces}<${prefix}${name}${ns}${nsvals}${dom.attrs(node)}`,closeTag=`</${prefix}${name}>`,childTags=Object.keys(node).filter(x=>"$ns"!=x&&0!=x.indexOf("@")).reduce((a,c,i)=>a+(nl+dom.generateNode(node[c],c,indent,nsmap,level+1)),"");""==childTags?tags.push(`${openTag}/>`):tags.push(`${openTag}>${childTags}${nl}${spaces}${closeTag}`)}}),tags.join(nl)}attrs(obj){return Object.keys(obj).filter(x=>0==x.indexOf("@")).reduce((a,c)=>a+=` ${c.substring(1)}="${obj[c]}"`,"")}space(x){return new Array(x).fill(" ").join("")}getURL(url,options){return JSDom.fetch(url,options)}static fetch(url,options){return new Promise(($res,$rej)=>{$res({res:{content:"<data>fetch method not reimplemented</data>",status:{code:404,text:"Fetch method not implemented"}}})})}}"apii.xml".split(".").reduce((a,e)=>a[e]=a[e]||{},window).JSDom=JSDom}(window),function(window){class Utils{static fetchDoc(url,type,agentClient){let doms=[],list=[{location:url,type:type||"wsdl"}];return new Promise(async($res,$rej)=>{for(;list.length>0;){let{location:location,type:type}=list.shift();console.log("fetching",type,location);let fetchOutcome=await agentClient.fetch(location);if(fetchOutcome.res.error)return console.info("An error occured while loading the doc at ",location),console.error(fetchOutcome.res.error),void $rej(fetchOutcome.error);if(200!=fetchOutcome.res.status.code)return console.info("An error occured while loading the doc at ",location),console.error(fetchOutcome.res.status),void $rej(fetchOutcome.res.status);let dom=new apii.xml.JSDom(fetchOutcome.res.content);doms.unshift({dom:dom,type:type}),"wsdl"==type&&dom.doc.definitions.import&&Utils.array(dom.import).forEach(importTag=>{"http://schemas.xmlsoap.org/wsdl/"==importTag.$ns&&list.push({location:new URL(importTag["@location"],location).toString(),type:"wsdl"})}),"wsdl"==type&&dom.doc.definitions.types&&dom.doc.definitions.types.schema&&Utils.array(dom.doc.definitions.types.schema).forEach(schema=>{Utils.array(schema.import).forEach(importTag=>{list.push({location:new URL(importTag["@schemaLocation"],location).toString(),type:"xsd"})})}),"xsd"==type&&dom.doc.schema.import&&Utils.array(dom.doc.schema.import).forEach(importTag=>{list.push({location:new URL(importTag["@schemaLocation"],location).toString(),type:"xsd"})})}$res(doms)})}static array(a){return a instanceof Array?a:[a]}}"apii.xml".split(".").reduce((a,e)=>a[e]=a[e]||{},window).Utils=Utils}(window),function(window){"apii.xml".split(".").reduce((a,e)=>a[e]=a[e]||{},window).WSDL=class extends apii.xml.JSDom{constructor(data){super(data),this.imports=[],this.types=null}fetch(location,options){let wsdl=this;return new Promise(async($res,$rej)=>{options.onprogress&&options.onprogress(`fetching wsdl ${location}`);let urlres=await wsdl.getURL(location,options);if(urlres.error)return void $rej(new Error(`An error occured while loading the doc at ${location}. Error: ${urlres.error.code}, ${urlres.error.message}`));if(wsdl.parse(urlres.content),wsdl["@location"]=location,!wsdl.doc.definitions)return void $res();for(let importTag of wsdl.array(wsdl.doc.definitions.import)){let importedWSDL=new apii.xml.WSDL;await importedWSDL.fetch(new URL(importTag["@location"],location).toString(),options),wsdl.imports.push(importedWSDL)}let types=wsdl.doc.definitions.types;if(types&&types.schema){let nsmap=Object.keys(wsdl.ns).reduce((a,c)=>(a[wsdl.ns[c]]=c,a),{}),schemaXML=wsdl.generateNode(types.schema,"schema",0,nsmap);wsdl.types=new apii.xml.XSD(schemaXML),wsdl.types["@location"]=location,await wsdl.types.fetchImports(location,options)}let schemaMap={},definitions=[],list=[{t:"wsdl",o:wsdl}];for(;list.length>0;){let item=list.shift();"wsdl"==item.t&&(item.o.types&&list.push({t:"xsd",o:item.o.types}),item.o.imports.forEach(w=>list.push({t:"wsdl",o:w})),definitions.push(item.o.doc.definitions)),"xsd"==item.t&&(schemaMap[item.o["@location"]]=item.o,item.o.imports.forEach(x=>list.push({t:"xsd",o:x})))}wsdl.schemas=Object.values(schemaMap).map(x=>({ns:x.ns,doc:x.doc,"@location":x["@location"]})),wsdl.definitions=definitions,$res()})}getSOAPPort(){let wsdl=this,data={portTypes:[],portTypeOperations:{}},portTypeMap={};wsdl.definitions.forEach(definition=>{portTypeMap=wsdl.array(definition.portType).reduce((a,pt)=>{let operationsMap=wsdl.array(pt.operation).reduce((ao,o)=>(ao[o["@name"]]=o,ao),{});return a[definition["@targetNamespace"]+"/"+pt["@name"]]=operationsMap,a},portTypeMap)});let bindingAddressMap={};wsdl.definitions.forEach(definition=>{wsdl.array(definition.service).forEach(ser=>{wsdl.array(ser.port).forEach(port=>{let bindingNameParts=port["@binding"].split(":"),ns=definition["@targetNamespace"];bindingNameParts.length>1&&(ns=definition[`@xmlns:${bindingNameParts[0]}`]);let bindingName=bindingNameParts[bindingNameParts.length-1];bindingAddressMap[`${ns}/${bindingName}`]=port.address["@location"]})})});let messageElementMap={};return wsdl.definitions.forEach(definition=>{wsdl.array(definition.message).forEach(message=>{let messageName=message["@name"],messageNS=definition["@targetNamespace"];if("parameters"==message.part["@name"]){let elementNameParts=message.part["@element"].split(":"),elementNS=definition["@targetNamespace"];elementNameParts.length>1&&(elementNS=definition[`@xmlns:${elementNameParts[0]}`]);let elementName=elementNameParts[elementNameParts.length-1];messageElementMap[`${messageNS}/${messageName}`]={ns:elementNS,name:elementName}}})}),wsdl.definitions.forEach(definition=>{wsdl.array(definition.binding).filter(binding=>binding.binding&&"http://schemas.xmlsoap.org/soap/http"==binding.binding["@transport"]&&"http://schemas.xmlsoap.org/wsdl/soap/"==binding.binding.$ns).forEach(soapBinding=>{let endPoint=bindingAddressMap[definition["@targetNamespace"]+"/"+soapBinding["@name"]],portTypeNameParts=soapBinding["@type"].split(":"),ns=definition["@targetNamespace"];portTypeNameParts.length>1&&(ns=definition[`@xmlns:${portTypeNameParts[0]}`]);let portTypeName=portTypeNameParts[portTypeNameParts.length-1];data.portTypes.push(portTypeName);let portTypeOperationsMap=portTypeMap[`${ns}/${portTypeName}`],portTypeOperations=[];wsdl.array(soapBinding.operation).forEach(soapOperation=>{let operation=portTypeOperationsMap[soapOperation["@name"]],messageNameParts=operation.input["@message"].split(":"),messageName=messageNameParts[messageNameParts.length-1],messageNameNS=definition["@targetNamespace"];messageNameParts.length>1&&(messageNameNS=definition[`@xmlns:${messageNameParts[0]}`]);let inputElement=messageElementMap[`${messageNameNS}/${messageName}`];portTypeOperations.push({...operation,soapAction:soapOperation.operation["@soapAction"],endPoint:endPoint,inputElement:inputElement})}),data.portTypeOperations[portTypeName]=portTypeOperations})}),data}}}(window),function(window){"apii.xml".split(".").reduce((a,e)=>a[e]=a[e]||{},window).XSD=class extends apii.xml.JSDom{constructor(data){super(data),this.imports=[],this.importMap={}}addDom(dom){let xsd=this;Object.keys(dom.doc).forEach(key=>wsdl.doc[key]=dom.ns[key]),Object.keys(dom.ns).forEach(key=>xsd.ns[key]=dom.ns[key])}fetch(location,options){let xsd=this;return new Promise(async($res,$rej)=>{options.onprogress&&options.onprogress(`fetching xsd ${location}`);let urlres=await xsd.getURL(location,options);urlres.error?$rej(new Error(`An error occured while loading the doc at ${location}. Error: ${urlres.error}`)):(xsd.parse(urlres.content),xsd["@location"]=location,await xsd.fetchImports(location,options),$res())})}fetchImports(location,options){let xsd=this;return new Promise(async($res,$rej)=>{for(let importTag of[...xsd.array(xsd.doc.schema.import),...xsd.array(xsd.doc.schema.include)]){let importURL=new URL(importTag["@schemaLocation"],location).toString();if(!xsd.importMap[importURL]){xsd.importMap[importURL]="fetched";let importedXSD=new apii.xml.XSD;importedXSD.importMap=xsd.importMap,await importedXSD.fetch(importURL,options),xsd.imports.push(importedXSD),delete importedXSD.importMap}}$res()})}createSchemaMap(){let xsd=this;xsd.schemaMap=xsd.schemas.reduce((a,xs)=>{let schema=xs.doc.schema;return a[`$ns/${schema["@targetNamespace"]}`]=xs,Object.keys(schema).forEach(key=>{xsd.array(schema[key]).filter(o=>o["@name"]).forEach(o=>{a[`${schema["@targetNamespace"]}/${o["@name"]}`]={defn:o,xsd:xs,type:key}})}),a},{})}typeOf(v,ns){let typeParts=v.split(":"),typeName=typeParts[typeParts.length-1],typeNS="http://www.w3.org/2001/XMLSchema";return typeParts.length>1&&(typeNS=ns[typeParts[0]]),{typeNS:typeNS,typeName:typeName}}createObject(name,ns,oname){let x=this,defn=x.schemaMap[`${ns}/${name}`].defn,defnType=x.schemaMap[`${ns}/${name}`].type,defnNS=x.schemaMap[`${ns}/${name}`].xsd.ns,xs=x.schemaMap[`$ns/${ns}`];if("element"==defnType){if(defn["@type"]){let{typeNS:typeNS,typeName:typeName}=x.typeOf(defn["@type"],defnNS);if("http://www.w3.org/2001/XMLSchema"!=typeNS){let ctDefn=x.schemaMap[`${typeNS}/${typeName}`].defn,obj={};return obj[oname||name]=x.createObjectFromComplexType(ctDefn,x.schemaMap[`$ns/${typeNS}`]),obj}}if(defn.complexType){let obj={};return obj[oname||name]=x.createObjectFromComplexType(defn.complexType,xs),obj}}if("complexType"==defnType){let obj={};return obj[oname||name]=x.createObjectFromComplexType(defn,xs),obj}return null}createObjectFromComplexType(ctdefn,xsd){let x=this,tns=xsd.doc.schema["@targetNamespace"],obj={$ns:tns};return ctdefn.sequence&&x.array(ctdefn.sequence.element).forEach(e=>{let field={},{typeNS:typeNS,typeName:typeName}=x.typeOf(e["@type"],xsd.ns);"http://www.w3.org/2001/XMLSchema"==typeNS?field.$value="":field=x.createObjectFromComplexType(x.schemaMap[`${typeNS}/${typeName}`],x.schemaMap[`$ns/${typeNS}`]),field.$ns=tns,obj[e["@name"]]=field}),ctdefn.choice&&x.array(ctdefn.choice.element).forEach(e=>{let field={},{typeNS:typeNS,typeName:typeName}=x.typeOf(e["@type"],xsd.ns);typeParts.length>1&&(typeNS=xsd[`@xmlns:${typeParts[0]}`]),"http://www.w3.org/2001/XMLSchema"==typeNS?field.$value="":field=x.createObjectFromComplexType(x.schemaMap[`${typeNS}/${typeName}`],x.schemaMap[`$ns/${typeNS}`]),field.$ns=tns,obj[e["@name"]]=field}),obj}}}(window),function(window){"apii.view".split(".").reduce((a,e)=>a[e]=a[e]||{},window).Inspector=class extends zn.Base{constructor(options){super(options),this.dialogActions={OKCANCEL:[{action:"ok",label:"OK",autohide:!1},{action:"cancel",label:"Cancel"}],CANCEL:[{action:"cancel",label:"Cancel"}],"WSDL-LOAD":[{action:"cancel",label:"Cancel"}]},this.inspection=this.emptyInspection(),this.callId=0,this.callbacks={},this.contextMessageHandlers={}}init(){this.vscode=acquireVsCodeApi(),this.setupUI(),this.setupEventHandlers()}setupUI(){this.initEditors(),this.publishToContext("/init","inspector init event")}setupEventHandlers(){let view=this;view._updatePanels=(()=>window.setTimeout(()=>view.updatePanels(),10)),view._updateTabScrollPosition=(()=>window.setTimeout(()=>view.updateTabScrollPosition(),0)),view.contextMessageHandlers["/load"]=view.loadInspection,view.contextMessageHandlers["/get"]=view.getInspection,view.setupWindoMessageHandler()}setupWindoMessageHandler(){let view=this;window.onmessage=(msg=>{if(console.log("received msg in subcontext",msg),"message"==msg.data.type){let messageHandler=view.contextMessageHandlers[msg.data.event];messageHandler&&messageHandler.apply(view,[msg.data])}if("call-response"==msg.data.type){let callback=view.callbacks[msg.data.callid];callback&&(callback(msg.data),delete view.callbacks[msg.data.callid])}if("call"==msg.data.type){let callid=msg.data.callid,messageHandler=view.contextMessageHandlers[msg.data.event];msg.data.reply=(res=>view.sendToContext({type:"call-response",event:msg.data.event,data:res,callid:callid})),messageHandler&&messageHandler.apply(view,[msg.data])}})}sendToContext(msg){console.log("sending msg to context",msg),this.vscode.postMessage(msg)}publishToContext(evt,data){this.sendToContext({type:"message",event:evt,data:data})}callAtContext(evt,data){let view=this;return view.callId++,new Promise((res$,rej$)=>{view.callbacks[view.callId]=res$,view.sendToContext({type:"call",event:evt,callid:view.callId,data:data})})}loadInspection(msg){this.inspection=msg.data.inspection,console.log(">>",msg),this.updatePanels(),this.apply()}getInspection(msg){this.savePanels(),msg.reply(this.inspection)}initEditors(){var cmeditoropts={value:"",lineNumbers:!0,lineWrapping:!0,matchBrackets:!0,autoCloseBrackets:!0,mode:"application/ld+json",foldGutter:!0,gutters:["CodeMirror-linenumbers","CodeMirror-foldgutter"],theme:"nord",viewportMargin:1/0};this.editors={},$(".service-req-editor").html(""),this.editors.request=CodeMirror($(".service-req-editor").get()[0],cmeditoropts),$(".service-res-editor").html(""),this.editors.response=CodeMirror($(".service-res-editor").get()[0],{...cmeditoropts,readOnly:!1}),this.updatePanels()}updatePanels(){this.editors.request.setValue(this.inspection.request.content),this.editors.request.setOption("mode",this.contentMode(this.inspection.request.headers)),$(".service-req .panel-body").scrollTop(0),this.editors.response.setValue(this.inspection.response.content),this.editors.response.setOption("mode",this.contentMode(this.inspection.response.headers)),$(".service-res .panel-body").scrollTop(0);let $leftPanel=$(".service-req");this.inspection.splitState?$leftPanel.css("flex-grow","0").css("flex-basis","unset").width(this.inspection.splitState.leftPanelWidth):$leftPanel.css("flex-grow","1").css("flex-basis","0")}savePanels(){this.inspection.request.content=this.editors.request.getValue()}resetPanels(){this.editors.request.setValue(""),this.editors.response.setValue(""),$(".service-req").css("flex-grow","1").css("flex-basis","0")}addRequestHeader($evt){$evt.preventDefault(),this.inspection.request.headers.push({header:"",value:""})}deleteRequestHeader(index,$evt){$evt.preventDefault(),this.inspection.request.headers.splice(index,1)}updateRequestHeader(index,type,$evt){this.inspection.request.headers[index][type]=$evt.newValue}panelSplit($evt){let view=this;if("dragstart"==$evt.name){let $leftPanel=$(".service-req"),$rightPanel=$(".service-res");view.splitState={leftPanelWidth:$leftPanel.width(),rightPanelWidth:$rightPanel.width()},$leftPanel.css("flex-grow","0").css("flex-basis","unset").width(view.splitState.leftPanelWidth)}"dragmove"==$evt.name&&view.splitState.leftPanelWidth+$evt.by.x>=250&&view.splitState.rightPanelWidth-$evt.by.x>=250&&$(".service-req").width(view.splitState.leftPanelWidth+$evt.by.x),"dragend"==$evt.name&&(view.splitState.leftPanelWidth+$evt.by.x>=250&&view.splitState.rightPanelWidth-$evt.by.x>=250&&($(".service-req").width(view.splitState.leftPanelWidth+$evt.by.x),view.splitState.leftPanelWidth+=$evt.by.x,view.inspection.splitState={leftPanelWidth:view.splitState.leftPanelWidth}),view.updatePanels())}emptyInspection(name){return{name:name||"Inspection",oid:zn.shortid(),target:{},request:{headers:[{header:"",value:""},{header:"",value:""},{header:"",value:""}],content:""},response:{headers:[{header:"",value:""},{header:"",value:""},{header:"",value:""}],content:""}}}addQuickInspectionTab(){this.ws.untitledCount++;let inspection=this.emptyInspection(`Inspection ${Math.floor(this.ws.untitledCount/10)}${this.ws.untitledCount%10}`);this.ws.inspections[inspection.oid]=inspection,(this.ws.untitled=this.ws.untitled||[]).push(inspection.oid),this.saveWS()}async send($event){this.savePanels();let inspection=zn.utils.copyObj({oid:this.inspection.oid,target:this.inspection.target,request:this.inspection.request,response:this.inspection.response}),headers=inspection.request.headers.filter(item=>item.header);inspection.request.headers=headers,this.sendTime=null;let receivedMsg=await this.callAtContext("/send",{inspection:inspection});this.onReceive(receivedMsg.data.inspection)}contentMode(headers){let contentType="application/json";return headers.forEach(item=>{"content-type"==item.header&&(contentType=item.value)}),0==contentType.indexOf("application/json")?"application/ld+json":0==contentType.indexOf("text/html")?"xml":0==contentType.indexOf("text/xml")?"xml":"application/ld+json"}formatResponse(inspection){let headers=inspection.response.headers,content=inspection.response.content,status=inspection.response.status,headersMap=headers.reduce((a,c)=>(a[c.header]=c.value,a),{});if(headers.unshift({header:"status",value:`${status.code} ${status.text}`}),inspection.response.isError=status.code<200||status.code>299,headersMap["content-type"]&&0==headersMap["content-type"].indexOf("application/json")&&(inspection.response.content=JSON.stringify(JSON.parse(content),null,4)),headersMap["content-type"]&&0==headersMap["content-type"].indexOf("text/html")){let options={indent_size:"4",indent_char:" ",max_preserve_newlines:"-1",preserve_newlines:!1,keep_array_indentation:!1,break_chained_methods:!1,indent_scripts:"normal",brace_style:"collapse",space_before_conditional:!0,unescape_strings:!1,jslint_happy:!1,end_with_newline:!1,wrap_line_length:"0",indent_inner_html:!1,comma_first:!1,e4x:!0,indent_empty_lines:!1};inspection.response.content=html_beautify(content,options)}if(headersMap["content-type"]&&0==headersMap["content-type"].indexOf("text/xml")){let jsdom=new apii.xml.JSDom(content);inspection.response.content=jsdom.generate(2)}}onReceive(inspection){this.formatResponse(inspection),this.inspection.response=inspection.response,this.apply(),this.updatePanels(),this.publishToContext("/update",{inspection:this.inspection})}}}(window);